# Single-Threaded Non-Blocking Networking Library

This library provides a few functions for quickly setting up a TCP server
with TLS. The intention is to use this library as a base for a single-threaded
network application, where it will provide a few abstraction functions for
reading and writing to connected clients.

![cequiq flow](doc/cequiq-flow.svg)

This library uses a custom *data frame* structure to read from clients. When a
complete frame is received, a user-set callback function is called with the
received data. You can also set up a callback function for when any connected
device gets disconnected.

Each connection gets a unique ID. You could easily create a hashmap to keep
track of this ID and provide it to the `write` (`cequiq_write`) function to
write to any connected client.

---

## Key Features  

- **Efficient epoll-based design** for handling multiple connections in a single thread  
- **Write queue** to prevent slow clients from blocking fast ones  
- **Frame-based** protocol for structured data handling
- **Non-blocking** I/O to keep everything responsive
- **TLS support** for secure communication


## Definition

**Data Frame**: A *data frame* is a structured unit of data that adheres to the format defined below.

## Frame Structure

**Prefix:** Every *data frame* must start with a `Prefix` value.

**Length:** Following the `Prefix`, an 8-byte field specifies the size of the **body**.
This value is stored in network byte order and must be converted to host byte order as a `uint64_t`.

**Body:** The body of the frame contains binary data.

**Note:** `Prefix` and `Lenght` are togather called `Head` and if expected `Head` is not
found at the start of a new frame then the connection will be closed.

---

# APIs

## DataCallback
Callback function triggered when a *data frame* is received.

```c
typedef void (*DataCallback)(const void *data, uint64_t size);
```

**Parameters:**
- `data` – Pointer to the received data.
- `size` – Size of the received data, the size of the **body**.


## CloseCallback
Callback function triggered when a connection is closed.

```c
typedef void (*CloseCallback)(const char *id);
```

**Parameters:**
- `id` – Identifier of the closed connection.


## CequiqConfig
Configuration structure for the Cequiq.

```c
typedef struct {
    uint16_t port_number;
    uint64_t max_data_frame_size;
    const char *certificate_file_name;
    const char *private_key_file_name;
    const char *server_directory;
    const char *ssl_cache_id;
    DataCallback data_callback;
    CloseCallback close_callback;
} CequiqConfig;
```

**Fields:**
- `port_number` – The listen port number.
- `max_data_frame_size` – Maximum size of a frame body. If exceeded, the connection is terminated.
- `certificate_file_name` – Certificate file name.
- `private_key_file_name` – Private key file name.
- `server_directory` – Path to a directory for storing persistent files required or generated by the server.
- `ssl_cache_id` – Unique identifier for the SSL session cache.
- `data_callback` – Function pointer for handling incoming *data frames*.
- `close_callback` – Function pointer for handling closed connections.


## Cequiq_init 
Creates a new Cequiq configuration instance.

```c
CequiqConfig *Cequiq_init();
```

**Returns:**
- Pointer to the newly allocated `CequiqConfig` structure.


## cequiq_start
Starts listening with the provided configuration.

```c
int cequiq_start(CequiqConfig *config);
```

**Parameters:**
- `config` – Pointer to a `CequiqConfig` structure.

**Returns:**
- `-1` on failure.


## get_connection_id
Retrieves own connection identifier.

```c
char *get_connection_id();
```

**Returns:**
- A dynamically allocated string containing the connection ID. The caller must free the memory.


## cequiq_write
Writes data to a connection. If `NULL` is provided for `conn_id` then the data will be sent to connection who triggered the callback.

```c
int cequiq_write(const char *conn_id, void *data, uint64_t size);
```

**Parameters:**
- `conn_id` – The connection ID or NULL.
- `data` – Pointer to the data to be written.
- `size` – Size of the data in bytes.

**Returns:**
- `-1` on failure.
